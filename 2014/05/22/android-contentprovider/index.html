<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android：内容提供者ContentProvider | slowalker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta content="article" property="og:type">
<meta content="Android：内容提供者ContentProvider" property="og:title">
<meta content="http://yoursite.com/2014/05/22/android-contentprovider/" property="og:url">
<meta property="og:image">
<meta content="slowalker" property="og:site_name">
<meta content="Personal Blog of Slowalker" property="og:description">
<meta content="summary" name="twitter:card">
  
    <link rel="alternative" href="/atom.xml" title="slowalker" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="http://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">slowalker</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/slowalker" title="Github" target="_blank"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed" target="_blank"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-android-contentprovider" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
<a href="/2014/05/22/android-contentprovider/" class="article-date">
  <time datetime="2014-05-22T05:26:54.000Z" itemprop="datePublished">5月 22 2014</time>
</a>


    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android：内容提供者ContentProvider
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
		
		<div id="toc" class="toc-article">
			<h2 class="toc-title"><span>文章目录</span></h2>
		
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Android内置的ContentProvider"><span class="toc-number">1.</span> <span class="toc-text">Android内置的ContentProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ContentProvider架构"><span class="toc-number">2.</span> <span class="toc-text">ContentProvider架构</span></a></li><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#URI结构"><span class="toc-number">2.1.</span> <span class="toc-text">URI结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MIME类型结构"><span class="toc-number">2.2.</span> <span class="toc-text">MIME类型结构</span></a></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#实现ContentProvider"><span class="toc-number">3.</span> <span class="toc-text">实现ContentProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考资料"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol>
		
		</div>
		
        <p>ContentProvider和Activity、Service、BroadcastReceiver并称Android四大组件。Android使用ContentProvider来将数据抽象为服务。ContentProvider的作用更像一种封装机制。需要实际的数据访问机制（比如SQLite）或者网络访问来获得基础的数据源。所以，只有希望在与外部或在应用程序之间共享数据时，才需要使用ContentProvider抽象。对于内部数据的访问，应用程序可以使用它认为适合的任何数据存储/访问机制，比如：首选项（Preference）、文件（File）、数据库（SQLite）、网络（Network）。<br><a id="more"></a></p>
<h3 id="Android内置的ContentProvider">Android内置的ContentProvider</h3>
<p>在详细介绍ContentProvider之前，先来看看Android内置的一些ContentProvider。</p>
<ul>
<li>Browser</li>
<li>CallLog</li>
<li>Contacts<ul>
<li>People</li>
<li>Phones</li>
<li>Photos</li>
<li>Groups</li>
</ul>
</li>
<li>MediaStore<ul>
<li>Audio<ul>
<li>Albums</li>
<li>Artists</li>
<li>Genres</li>
<li>Playlists</li>
</ul>
</li>
<li>Images<ul>
<li>Thumbnails</li>
</ul>
</li>
<li>Video</li>
</ul>
</li>
<li>Settings<br>顶级项是数据库，较低级的项是表。所以，Browser、CallLog、Contacts、MediaStore和Settings都是封装为ContentProvider的独立的SQLite数据库。这些SQLite数据库通常具有扩展名.db，仅能从实现包访问。任何来自该包外的访问都需要通过ContentProvider接口。<h3 id="ContentProvider架构">ContentProvider架构</h3>
ContentProvider类似于Web服务的内部机制。与网站一样，设备上每个ContentProvider都会使用字符串注册自身，这个字符串类似于域名，但称为授权（authority）。授权的注册在AndroidManifest.xml中进行，下面给出一个简单的示例：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">provider</span> <span class="attribute">android:name</span>=<span class="value">"SomeProvider"</span>
    <span class="attribute">android:authorites</span>=<span class="value">"com.your-company.SeomProvider"</span>/&gt;</span>
<span class="tag">&lt;<span class="title">provider</span> <span class="attribute">android:name</span>=<span class="value">"NotePadProvider"</span>
    <span class="attribute">android:authorites</span>=<span class="value">"com.google.provider.NotePad"</span>/&gt;</span>
</pre></td></tr></table></figure>

<h4 id="URI结构">URI结构</h4>
<p>授权就像ContentProvider的域名，在进行了授权注册之后，这些ContentProvider就拥有了以授权前缀开头的URL：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>content://com.your-company.SomeProvider
content://com.google.provider.NotePad
</pre></td></tr></table></figure>

<p>Android内容URI的一般结构为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>content://*/*/*
content://authority-name/path-segment1/seg-segment2/etc..
</pre></td></tr></table></figure>

<p>下面给出一个示例URI，它标识笔记数据库中编号为23的笔记：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>content://com.google.provider.NotePad/notes/23
</pre></td></tr></table></figure>

<h4 id="MIME类型结构">MIME类型结构</h4>
<p>MIME类型在android中的工作方式与在HTTP中类似。你向ContentProvider询问它支持的给定的URI的MIME类型，ContentProvider返回一个包含两部分的字符串，该字符串根据标准的Web MIME约定标识URI的MIME类型。<br>对于单条记录，MIME类型的一般形式为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>vnd.android.cursor.item/vnd.your-company.contenttype
</pre></td></tr></table></figure>

<p>对于记录或行的集合，MIME类型的一般形式为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>vnd.android.cursor.dir/vnd.your-company.contenttype
</pre></td></tr></table></figure>

<h3 id="实现ContentProvider">实现ContentProvider</h3>
<p>定义数据库的元数据BookProviderMetaData</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="code"><pre><span class="keyword">package</span> com.sl.provider;

<span class="keyword">import</span> android.net.Uri;
<span class="keyword">import</span> android.provider.BaseColumns;
<span class="javadoc">/**
 * Meta Data of BookProvider
 */</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookProviderMetaData</span> {</span>

	<span class="javadoc">/** Authority name of the content provider */</span>
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">"com.androidbook.provider.BookProvider"</span>;
	<span class="javadoc">/** database name */</span>
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_NAME = <span class="string">"book.db"</span>;
	<span class="javadoc">/** database version, used when create your database. */</span>
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATABASE_VERSION = <span class="number">1</span>;
	<span class="javadoc">/** table name */</span>
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOKS_TABLE_NAME = <span class="string">"books"</span>;
	
	<span class="keyword">private</span> <span class="title">BookProviderMetaData</span>() {}
	
	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BookTableMetaData</span> <span class="keyword">implements</span> <span class="title">BaseColumns</span> {</span>
		
		<span class="keyword">private</span> <span class="title">BookTableMetaData</span>() {}
		<span class="javadoc">/** table name */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TABLE_NAME = <span class="string">"books"</span>;
		<span class="javadoc">/** content uri */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri CONTENT_URI = Uri.parse(<span class="string">"content://"</span> + AUTHORITY + <span class="string">"/books"</span>);
		<span class="javadoc">/** content mime type */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_TYPE = <span class="string">"vnd.android.cursor.dir/vnd.androidbook.book"</span>;
		<span class="javadoc">/** content item mime type */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_ITEM_TYPE = <span class="string">"vnd.android.cursor.item/vnd.androidbook.book"</span>;
		<span class="javadoc">/** default ordered by */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SORT_ORDER = <span class="string">"modified DESC"</span>;
		<span class="javadoc">/** book name projection */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOK_NAME = <span class="string">"name"</span>;
		<span class="javadoc">/** book isbn projection */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOK_ISBN = <span class="string">"isbn"</span>;
		<span class="javadoc">/** book author projection */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOK_AUTHOR = <span class="string">"author"</span>;
		<span class="javadoc">/** book create date projection */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CREATE_DATE = <span class="string">"created"</span>;
		<span class="javadoc">/** book modified date projection */</span>
		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MODIFIED_DATE = <span class="string">"modified"</span>;
	}
	
	
}
</pre></td></tr></table></figure>

<p>实现BookProvider内容提供程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
</pre></td><td class="code"><pre><span class="keyword">package</span> com.sl.provider;

<span class="keyword">import</span> java.util.HashMap;

<span class="keyword">import</span> com.sl.provider.BookProviderMetaData.BookTableMetaData;

<span class="keyword">import</span> android.content.ContentProvider;
<span class="keyword">import</span> android.content.ContentUris;
<span class="keyword">import</span> android.content.ContentValues;
<span class="keyword">import</span> android.content.Context;
<span class="keyword">import</span> android.content.UriMatcher;
<span class="keyword">import</span> android.database.Cursor;
<span class="keyword">import</span> android.database.sqlite.SQLiteDatabase;
<span class="keyword">import</span> android.database.sqlite.SQLiteException;
<span class="keyword">import</span> android.database.sqlite.SQLiteOpenHelper;
<span class="keyword">import</span> android.database.sqlite.SQLiteQueryBuilder;
<span class="keyword">import</span> android.net.Uri;
<span class="keyword">import</span> android.text.TextUtils;
<span class="keyword">import</span> android.util.Log;

<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> {</span>

	<span class="javadoc">/** debug tag */</span>
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = BookProvider.class.getSimpleName();
	<span class="javadoc">/** 
	 * The projection map maps from column names that the caller passes into query to
	 * database column names. This is useful for renaming columns as well as disambiguating
	 * column names when doing joins. For example you could map "name" to "people.name".
	 * If a projection map is set it must contain all column names the user may request, 
	 * even if the key and value are the same. 
	 */</span>
	<span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, String&gt; sBooksProjectionMap;
	
	<span class="keyword">static</span> {
		sBooksProjectionMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();
		sBooksProjectionMap.put(BookTableMetaData._ID, BookTableMetaData._ID);
		sBooksProjectionMap.put(BookTableMetaData.BOOK_NAME, BookTableMetaData.BOOK_NAME);
		sBooksProjectionMap.put(BookTableMetaData.BOOK_ISBN, BookTableMetaData.BOOK_ISBN);
		sBooksProjectionMap.put(BookTableMetaData.BOOK_AUTHOR, BookTableMetaData.BOOK_AUTHOR);
		sBooksProjectionMap.put(BookTableMetaData.CREATE_DATE, BookTableMetaData.CREATE_DATE);
	}
	<span class="javadoc">/** The UriMatcher is a utility class to aid in matching URIs in content providers. */</span>
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UriMatcher sUriMatcher;
	
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INCOMING_BOOK_COLLECTION_URI_INDICATOR = <span class="number">1</span>;
	
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INCOMING_SINGLE_BOOK_URI_INDICATOR = <span class="number">2</span>;
	
	<span class="keyword">static</span> {
		sUriMatcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);
		<span class="javadoc">/**
		 * Add a URI to match, and the code to return when this URI is matched. 
		 * URI nodes may be exact match string, the token "*" that matches any text,
		 *  or the token "#" that matches only numbers.
		 */</span>
		sUriMatcher.addURI(BookProviderMetaData.AUTHORITY, <span class="string">"books"</span>, INCOMING_BOOK_COLLECTION_URI_INDICATOR);
		sUriMatcher.addURI(BookProviderMetaData.AUTHORITY, <span class="string">"books/#"</span>, INCOMING_SINGLE_BOOK_URI_INDICATOR);
	}
	<span class="javadoc">/** SQLiteDatabase is used to store data in this content provider.*/</span>
	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseHelper</span> <span class="keyword">extends</span> <span class="title">SQLiteOpenHelper</span> {</span>

		<span class="keyword">public</span> <span class="title">DatabaseHelper</span>(Context context) {
			<span class="keyword">super</span>(context, BookProviderMetaData.DATABASE_NAME, <span class="keyword">null</span>, BookProviderMetaData.DATABASE_VERSION);
		}
		
		<span class="annotation">@Override</span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>(SQLiteDatabase db) {
			Log.d(TAG, <span class="string">"DatabaseHelper.onCreate()"</span>);
			db.execSQL(<span class="string">"CREATE TABLE "</span> + BookTableMetaData.TABLE_NAME + <span class="string">" ("</span>
					+ BookTableMetaData._ID + <span class="string">" INTEGER PRIMARY KEY, "</span>
					+ BookTableMetaData.BOOK_NAME + <span class="string">" TEXT, "</span>
					+ BookTableMetaData.BOOK_ISBN + <span class="string">" TEXT, "</span>
					+ BookTableMetaData.BOOK_AUTHOR + <span class="string">" TEXT, "</span>
					+ BookTableMetaData.CREATE_DATE + <span class="string">" INTEGER, "</span>
					+ BookTableMetaData.MODIFIED_DATE + <span class="string">" INTEGER"</span>
					+ <span class="string">");"</span>);
		}

		<span class="annotation">@Override</span>
		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span>(SQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion) {
			Log.d(TAG, <span class="string">"DatabaseHelper.onUpgrade()"</span>);
			db.execSQL(<span class="string">"DROP TABLE IF EXISTS "</span> + BookTableMetaData.TABLE_NAME);
			onCreate(db);
			
		}
		
	}
	
	<span class="keyword">private</span> DatabaseHelper mOpenHelper;

	<span class="annotation">@Override</span>
	<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span>() {
		<span class="comment">//Implement onCreate() to initialize the content provider on startup. </span>
		Log.d(TAG, <span class="string">"onCreate()"</span>);
		mOpenHelper = <span class="keyword">new</span> DatabaseHelper(getContext());
		<span class="keyword">return</span> <span class="keyword">true</span>;
	}

	<span class="annotation">@Override</span>
	<span class="keyword">public</span> Cursor <span class="title">query</span>(Uri uri, String[] projection, String selection,
			String[] selectionArgs, String sortOrder) {
		<span class="comment">//Implement query() to query the data.</span>
		SQLiteQueryBuilder qb = <span class="keyword">new</span> SQLiteQueryBuilder();
		<span class="keyword">switch</span> (sUriMatcher.match(uri)) {
		<span class="keyword">case</span> INCOMING_BOOK_COLLECTION_URI_INDICATOR:
			qb.setTables(BookTableMetaData.TABLE_NAME);
			qb.setProjectionMap(sBooksProjectionMap);
			<span class="keyword">break</span>;
		<span class="keyword">case</span> INCOMING_SINGLE_BOOK_URI_INDICATOR:
			qb.setTables(BookTableMetaData.TABLE_NAME);
			qb.setProjectionMap(sBooksProjectionMap);
			qb.appendWhere(BookTableMetaData._ID + <span class="string">"="</span> + uri.getPathSegments().get(<span class="number">1</span>));
			<span class="keyword">break</span>;
		<span class="keyword">default</span>:
			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unknown URI: "</span> + uri);	
		}
		
		String orderBy;
		<span class="keyword">if</span> (TextUtils.isEmpty(sortOrder)) {
			orderBy = BookTableMetaData.DEFAULT_SORT_ORDER;
		} <span class="keyword">else</span> {
			orderBy = sortOrder;
		}
		
		SQLiteDatabase db = mOpenHelper.getReadableDatabase();
		
		Cursor c = qb.query(db, projection, selection, selectionArgs, <span class="keyword">null</span>, <span class="keyword">null</span>, orderBy);
		c.setNotificationUri(getContext().getContentResolver(), uri);
		<span class="keyword">return</span> c;
	}

	<span class="annotation">@Override</span>
	<span class="keyword">public</span> String <span class="title">getType</span>(Uri uri) {
		<span class="comment">//Implement getType() to handle requests for the MIME type of the data at the given URI.</span>
		<span class="comment">//The returned MIME type should start with vnd.android.cursor.item/ for a single record,</span>
		<span class="comment">//or vnd.android.cursor.dir/ for multiple items.</span>
		<span class="keyword">switch</span> (sUriMatcher.match(uri)) {
		<span class="keyword">case</span> INCOMING_BOOK_COLLECTION_URI_INDICATOR:
			<span class="keyword">return</span> BookTableMetaData.CONTENT_TYPE;
		<span class="keyword">case</span> INCOMING_SINGLE_BOOK_URI_INDICATOR:
			<span class="keyword">return</span> BookTableMetaData.CONTENT_ITEM_TYPE;
		<span class="keyword">default</span>:
			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unknown URI: "</span> + uri);
		}
	}

	<span class="annotation">@Override</span>
	<span class="keyword">public</span> Uri <span class="title">insert</span>(Uri uri, ContentValues values) {
		<span class="comment">//Implemnt insert() to insert data.</span>
		<span class="keyword">if</span> (sUriMatcher.match(uri) != INCOMING_BOOK_COLLECTION_URI_INDICATOR) {
			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessError(<span class="string">"unknown URI: "</span> + uri);
		}
		ContentValues cv;
		<span class="keyword">if</span> (values != <span class="keyword">null</span>) {
			cv = values;
		} <span class="keyword">else</span> {
			cv = <span class="keyword">new</span> ContentValues();
		}
		
		Long now = System.currentTimeMillis();
		
		<span class="keyword">if</span> (!cv.containsKey(BookTableMetaData.CREATE_DATE) ) {
			cv.put(BookTableMetaData.CREATE_DATE, now);
		}
		<span class="keyword">if</span> (!cv.containsKey(BookTableMetaData.MODIFIED_DATE)) {
			cv.put(BookTableMetaData.MODIFIED_DATE, now);
		}
		<span class="keyword">if</span> (!cv.containsKey(BookTableMetaData.BOOK_NAME)) {
			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Failed to insert row because Book Name is needed "</span> + uri);
		}
		<span class="keyword">if</span> (!cv.containsKey(BookTableMetaData.BOOK_ISBN)) {
			cv.put(BookTableMetaData.BOOK_ISBN, <span class="string">"unknown isbn"</span>);
		}
		<span class="keyword">if</span> (!cv.containsKey(BookTableMetaData.BOOK_AUTHOR)) {
			cv.put(BookTableMetaData.BOOK_AUTHOR, <span class="string">"unknown author"</span>);
		}
		
		SQLiteDatabase db = mOpenHelper.getWritableDatabase();
		<span class="keyword">long</span> rowId = db.insert(BookTableMetaData.TABLE_NAME, BookTableMetaData.BOOK_NAME, cv);
		<span class="keyword">if</span> (rowId &gt; <span class="number">0</span>) {
			Uri insertedBookUri = ContentUris.withAppendedId(BookTableMetaData.CONTENT_URI, rowId);
			getContext().getContentResolver().notifyChange(insertedBookUri, <span class="keyword">null</span>);
			<span class="keyword">return</span> insertedBookUri;
		} <span class="keyword">else</span> {
			<span class="keyword">throw</span> <span class="keyword">new</span> SQLiteException(<span class="string">"Failed to insert row into "</span> + uri);
		}
	}

	<span class="annotation">@Override</span>
	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span>(Uri uri, String selection, String[] selectionArgs) {
		<span class="comment">//Implement delete() to delete data.</span>
		SQLiteDatabase db = mOpenHelper.getWritableDatabase();
		<span class="keyword">int</span> count;
		<span class="keyword">switch</span> (sUriMatcher.match(uri)) {
		<span class="keyword">case</span> INCOMING_BOOK_COLLECTION_URI_INDICATOR:
			count = db.delete(BookTableMetaData.TABLE_NAME, selection, selectionArgs);
			<span class="keyword">break</span>;
		<span class="keyword">case</span> INCOMING_SINGLE_BOOK_URI_INDICATOR:
			String rowId = uri.getPathSegments().get(<span class="number">1</span>);
			String whereClause = BookTableMetaData._ID + <span class="string">"="</span> + rowId;
			<span class="keyword">if</span> (!TextUtils.isEmpty(selection)) {
				whereClause += <span class="string">" AND ("</span> + selection + <span class="string">")"</span>;
			}
			count = db.delete(BookTableMetaData.TABLE_NAME, whereClause, selectionArgs);
			<span class="keyword">break</span>;
		<span class="keyword">default</span>:
			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unknown URI: "</span> + uri);	
		}
		getContext().getContentResolver().notifyChange(uri, <span class="keyword">null</span>);
		<span class="keyword">return</span> count;
	}

	<span class="annotation">@Override</span>
	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span>(Uri uri, ContentValues values, String selection,
			String[] selectionArgs) {
		<span class="comment">//Implement update() to update data.</span>
		SQLiteDatabase db = mOpenHelper.getWritableDatabase();
		<span class="keyword">int</span> count;
		<span class="keyword">switch</span> (sUriMatcher.match(uri)) {
		<span class="keyword">case</span> INCOMING_BOOK_COLLECTION_URI_INDICATOR:
			count = db.update(BookTableMetaData.TABLE_NAME, values, selection, selectionArgs);
			<span class="keyword">break</span>;
		<span class="keyword">case</span> INCOMING_SINGLE_BOOK_URI_INDICATOR:
			String rowId = uri.getPathSegments().get(<span class="number">1</span>);
			String whereClause = BookTableMetaData._ID + <span class="string">"="</span> + rowId;
			<span class="keyword">if</span> (!TextUtils.isEmpty(selection)) {
				whereClause += <span class="string">" AND ("</span> + selection + <span class="string">")"</span>;
			}
			count = db.update(BookTableMetaData.TABLE_NAME, values, whereClause, selectionArgs);
			<span class="keyword">break</span>;
		<span class="keyword">default</span>:
			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unknown URI: "</span> + uri);
		}
		getContext().getContentResolver().notifyChange(uri, <span class="keyword">null</span>);
		<span class="keyword">return</span> count;
	}

}
</pre></td></tr></table></figure>

<p>在AndroidManifext中声明</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">provider</span> <span class="attribute">android:name</span>=<span class="value">"com.sl.provider.BookProvider"</span>
    <span class="attribute">android:authorities</span>=<span class="value">"com.androidbook.provider.BookProvider"</span>
    <span class="attribute">android:exported</span>=<span class="value">"true"</span>/&gt;</span>
</pre></td></tr></table></figure>

<p>MainActivity所用布局文件activity_mail.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span>
    <span class="attribute">xmlns:tools</span>=<span class="value">"http://schemas.android.com/tools"</span>
    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span>
    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>
    <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span> &gt;</span>

    <span class="tag">&lt;<span class="title">Button</span> <span class="attribute">android:id</span>=<span class="value">"@+id/add"</span>
        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span>
        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span>
        <span class="attribute">android:text</span>=<span class="value">"add book"</span>/&gt;</span>
    
    <span class="tag">&lt;<span class="title">Button</span> <span class="attribute">android:id</span>=<span class="value">"@+id/count"</span>
        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span>
        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span>
        <span class="attribute">android:text</span>=<span class="value">"get book account"</span>/&gt;</span>
    
    <span class="tag">&lt;<span class="title">Button</span> <span class="attribute">android:id</span>=<span class="value">"@+id/remove"</span>
        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span>
        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span>
        <span class="attribute">android:text</span>=<span class="value">"remove book"</span>/&gt;</span>
    
    <span class="tag">&lt;<span class="title">Button</span> <span class="attribute">android:id</span>=<span class="value">"@+id/show"</span>
        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span>
        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span>
        <span class="attribute">android:text</span>=<span class="value">"show books"</span>/&gt;</span>
<span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span>
</pre></td></tr></table></figure>

<p>MainActivity中使用ContentProvider来操作数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
</pre></td><td class="code"><pre><span class="keyword">package</span> com.sl.provider;

<span class="keyword">import</span> com.sl.provider.BookProviderMetaData.BookTableMetaData;

<span class="keyword">import</span> android.net.Uri;
<span class="keyword">import</span> android.os.Bundle;
<span class="keyword">import</span> android.app.Activity;
<span class="keyword">import</span> android.content.ContentResolver;
<span class="keyword">import</span> android.content.ContentValues;
<span class="keyword">import</span> android.database.Cursor;
<span class="keyword">import</span> android.util.Log;
<span class="keyword">import</span> android.view.Menu;
<span class="keyword">import</span> android.view.View;
<span class="keyword">import</span> android.view.View.OnClickListener;
<span class="keyword">import</span> android.widget.Button;

<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">OnClickListener</span> {</span>

	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = MainActivity.class.getSimpleName();
	
	<span class="keyword">private</span> Button addBtn;
	<span class="keyword">private</span> Button removeBtn;
	<span class="keyword">private</span> Button countBtn;
	<span class="keyword">private</span> Button showBtn;
	
	<span class="annotation">@Override</span>
	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span>(Bundle savedInstanceState) {
		<span class="keyword">super</span>.onCreate(savedInstanceState);
		Log.d(TAG, <span class="string">"onCreate()"</span>);
		setContentView(R.layout.activity_main);
		
		addBtn = (Button) findViewById(R.id.add);
		removeBtn = (Button) findViewById(R.id.remove);
		countBtn = (Button) findViewById(R.id.count);
		showBtn = (Button) findViewById(R.id.show);
		
		addBtn.setOnClickListener(<span class="keyword">this</span>);
		removeBtn.setOnClickListener(<span class="keyword">this</span>);
		countBtn.setOnClickListener(<span class="keyword">this</span>);
		showBtn.setOnClickListener(<span class="keyword">this</span>);
	}

	
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span>() {
		ContentValues cv = <span class="keyword">new</span> ContentValues();
		cv.put(BookTableMetaData.BOOK_NAME, <span class="string">"book-1"</span>);
		cv.put(BookTableMetaData.BOOK_ISBN, <span class="string">"isbn-1"</span>);
		cv.put(BookTableMetaData.BOOK_AUTHOR, <span class="string">"author-1"</span>);
		
		ContentResolver resolver = getContentResolver();
		Uri uri = BookTableMetaData.CONTENT_URI;
		Log.d(TAG, <span class="string">"add Book: inserte Uri = "</span> + uri); 
		Uri insertedUri = resolver.insert(uri, cv);
		Log.d(TAG, <span class="string">"add Book: inserted Uri = "</span> + insertedUri); 
	}
	
	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span>() {
		Uri uri = BookTableMetaData.CONTENT_URI;
		Cursor c = getContentResolver().query(uri, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);
		<span class="keyword">int</span> count = c.getCount();
		c.close();
		Log.d(TAG, <span class="string">"getCount: count = "</span> + count);
		<span class="keyword">return</span> count;
	}
	
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeBook</span>() {
		<span class="keyword">int</span> count = getCount();
		ContentResolver resolver = getContentResolver();
		Uri uri = BookTableMetaData.CONTENT_URI;
		Uri delUri = Uri.withAppendedPath(uri, Integer.toString(count));
		Log.d(TAG, <span class="string">"removeBook: delUri = "</span> + delUri);
		resolver.delete(delUri, <span class="keyword">null</span>, <span class="keyword">null</span>);
		Log.d(TAG, <span class="string">"after removed, count = "</span> + getCount());
	}
	
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showBooks</span>() {
		Uri uri = BookTableMetaData.CONTENT_URI;
		Cursor c = getContentResolver().query(uri, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);
		<span class="keyword">int</span> iname = c.getColumnIndex(BookTableMetaData.BOOK_NAME);
		<span class="keyword">int</span> iisbn = c.getColumnIndex(BookTableMetaData.BOOK_ISBN);
		<span class="keyword">int</span> iauthor = c.getColumnIndex(BookTableMetaData.BOOK_AUTHOR);
		<span class="keyword">for</span> (c.moveToFirst(); !c.isAfterLast(); c.moveToNext()) {
			String id = c.getString(<span class="number">1</span>);
			String name = c.getString(iname);
			String isbn = c.getString(iisbn);
			String author = c.getString(iauthor);
			StringBuilder sb = <span class="keyword">new</span> StringBuilder(id);
			sb.append(<span class="string">","</span> + name)
			  .append(<span class="string">","</span> + isbn)
			  .append(<span class="string">","</span> + author);
			Log.d(TAG, <span class="string">"showBooks: "</span> + sb.toString());
		}
		c.close();
	}


	<span class="annotation">@Override</span>
	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span>(View v) {
		<span class="keyword">switch</span> (v.getId()) {
		<span class="keyword">case</span> R.id.add:
			addBook();
			<span class="keyword">break</span>;
		<span class="keyword">case</span> R.id.remove:
			removeBook();
			<span class="keyword">break</span>;
		<span class="keyword">case</span> R.id.count:
			getCount();
			<span class="keyword">break</span>;
		<span class="keyword">case</span> R.id.show:
			showBooks();
			<span class="keyword">break</span>;
		<span class="keyword">default</span>:
			<span class="keyword">break</span>;
		}
		
	}

}
</pre></td></tr></table></figure>

<h3 id="参考资料">参考资料</h3>
<p>《Android Pro 3》 Chapter4 - ContentProvider</p>

      
    </div>
    <footer class="article-footer">
	  
	  <!-- 百度分享 Start -->
	  <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
	  <!-- 百度分享 End -->
	  
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ContentProvider/">ContentProvider</a></li></ul>

	  
<span>
更新日期:<time datetime="2014-05-22T05:30:16.000Z" itemprop="dateModified">5月 22 2014</time>
</span>


    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2014/05/21/alog_prim_selector/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">算法：素数筛法</div>
    </a>
  
</nav>

  
</article>



<!-- 多说评论框 start -->

<!-- 多说评论框 end -->
</section>
        
          
  <div id="toc" class="toc-aside">
  <h2 class="toc-title">文章目录</h2>
  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Android内置的ContentProvider"><span class="toc-number">1.</span> <span class="toc-text">Android内置的ContentProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ContentProvider架构"><span class="toc-number">2.</span> <span class="toc-text">ContentProvider架构</span></a></li><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#URI结构"><span class="toc-number">2.1.</span> <span class="toc-text">URI结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MIME类型结构"><span class="toc-number">2.2.</span> <span class="toc-text">MIME类型结构</span></a></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#实现ContentProvider"><span class="toc-number">3.</span> <span class="toc-text">实现ContentProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考资料"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol>
  </div>

<aside id="sidebar">

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/心境·回家的路/">心境·回家的路</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ContentProvider/">ContentProvider</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/InnerClass/">InnerClass</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebView/">WebView</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interface/">interface</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/心灵的旅途/">心灵的旅途</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/素数筛法/">素数筛法</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/ContentProvider/" style="font-size: NaNpx; color: #NaNNaNNaN;">ContentProvider</a><a href="/tags/InnerClass/" style="font-size: NaNpx; color: #NaNNaNNaN;">InnerClass</a><a href="/tags/Network/" style="font-size: NaNpx; color: #NaNNaNNaN;">Network</a><a href="/tags/WebView/" style="font-size: NaNpx; color: #NaNNaNNaN;">WebView</a><a href="/tags/interface/" style="font-size: NaNpx; color: #NaNNaNNaN;">interface</a><a href="/tags/心灵的旅途/" style="font-size: NaNpx; color: #NaNNaNNaN;">心灵的旅途</a><a href="/tags/素数筛法/" style="font-size: NaNpx; color: #NaNNaNNaN;">素数筛法</a>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">archive</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05">五月 2014</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/05/22/android-contentprovider/">Android：内容提供者ContentProvider</a>
          </li>
        
          <li>
            <a href="/2014/05/21/alog_prim_selector/">算法：素数筛法</a>
          </li>
        
          <li>
            <a href="/2014/05/15/android-download/">Android：基于HTTP协议实现数据下载</a>
          </li>
        
          <li>
            <a href="/2014/05/12/java-innerclass/">Java内部类小结</a>
          </li>
        
          <li>
            <a href="/2014/05/12/java-interface/">Java接口(interface)小结</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    

  

</aside>

        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 slowalker<br>
      Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/howiefh/hexo-theme-landscape-f" target="_blank" title="Landscape-F">Landscape-F</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<!-- 多说公共JS代码 start (一个网页只需插入一次) -->

<!-- 多说公共JS代码 end -->

<!-- 百度分享 start -->

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","douban","bdysc","sqq","qq","hi","baidu","huaban","youdao","sdo","mail","xg","diandian","fx","copy","print"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

<!-- 百度分享 end -->

<!--
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.min.js"></script>
-->
<script type="text/javascript" src="/js/jquery.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>


<div class="bottom-btn">

	<a class="icon-gotop" href="javascript:void(0)" title="返回顶部"></a>
	<script type="text/javascript" src="/js/gotop.js"></script>
	<!--
	<script src="/js/gotop.js"></script>
	-->


	<a class="icon-toc-toggle" href="javascript:void(0)" title="文章目录"></a>
	<!--
	<script src="/js/toc_aside_toggle.js"></script>
	-->

</div>
<script type="text/javascript" src="/js/toc_aside_toggle.js"></script>


<script type="text/javascript" src="/js/script.js"></script>

  </div>
</body>
</html>